<!DOCTYPE html>
<html>
<head>
    <title>Test Ephemeral Keys</title>
</head>
<body>
    <h1>Testing Ephemeral Key Generation with Real secp256k1</h1>
    <button id="testBtn">Generate Ephemeral Keys</button>
    <div id="results"></div>

    <script>
        async function loadWasm() {
            const response = await fetch('./visualizer/src/nostr_mls.wasm');
            const wasmBuffer = await response.arrayBuffer();
            
            let wasmMemory = null;
            
            const imports = {
                env: {
                    getRandomValues: (ptr, len) => {
                        if (!wasmMemory) throw new Error('WASM memory not available');
                        const bytes = new Uint8Array(wasmMemory.buffer, ptr, len);
                        crypto.getRandomValues(bytes);
                        console.log('Generated random bytes:', Array.from(bytes).slice(0, 8).map(b => b.toString(16).padStart(2, '0')).join(' '));
                    },
                    wasm_log_error: (strPtr, len) => {
                        if (!wasmMemory) throw new Error('WASM memory not available');
                        const bytes = new Uint8Array(wasmMemory.buffer, strPtr, len);
                        const message = new TextDecoder().decode(bytes);
                        console.error('secp256k1 error:', message);
                    }
                }
            };
            
            const wasmModule = await WebAssembly.compile(wasmBuffer);
            const instance = await WebAssembly.instantiate(wasmModule, imports);
            
            wasmMemory = instance.exports.memory;
            
            return instance.exports;
        }

        function bytesToHex(bytes) {
            return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        document.getElementById('testBtn').addEventListener('click', async () => {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Loading WASM...</p>';
            
            try {
                const wasm = await loadWasm();
                
                // Test regular identity creation
                const privateKeyPtr = wasm.wasm_alloc(32);
                const publicKeyPtr = wasm.wasm_alloc(32);
                
                const success = wasm.wasm_create_identity(privateKeyPtr, publicKeyPtr);
                
                if (!success) {
                    throw new Error('Failed to create identity');
                }
                
                const privateKey = new Uint8Array(wasm.memory.buffer, privateKeyPtr, 32);
                const publicKey = new Uint8Array(wasm.memory.buffer, publicKeyPtr, 32);
                
                const identity = {
                    privateKey: bytesToHex(privateKey),
                    publicKey: bytesToHex(publicKey)
                };
                
                wasm.wasm_free(privateKeyPtr, 32);
                wasm.wasm_free(publicKeyPtr, 32);
                
                // Test ephemeral key generation
                const ephemeralResults = [];
                for (let i = 0; i < 3; i++) {
                    const ephPrivKeyPtr = wasm.wasm_alloc(32);
                    const ephPubKeyPtr = wasm.wasm_alloc(32);
                    
                    const ephSuccess = wasm.wasm_generate_ephemeral_keys(ephPrivKeyPtr, ephPubKeyPtr);
                    
                    if (!ephSuccess) {
                        throw new Error('Failed to generate ephemeral keys');
                    }
                    
                    const ephPrivKey = new Uint8Array(wasm.memory.buffer, ephPrivKeyPtr, 32);
                    const ephPubKey = new Uint8Array(wasm.memory.buffer, ephPubKeyPtr, 32);
                    
                    ephemeralResults.push({
                        privateKey: bytesToHex(ephPrivKey),
                        publicKey: bytesToHex(ephPubKey)
                    });
                    
                    wasm.wasm_free(ephPrivKeyPtr, 32);
                    wasm.wasm_free(ephPubKeyPtr, 32);
                }
                
                results.innerHTML = `
                    <h2>Success! Real secp256k1 Cryptography Working!</h2>
                    
                    <h3>Identity Key Pair:</h3>
                    <p><strong>Private Key:</strong> ${identity.privateKey.slice(0, 32)}...</p>
                    <p><strong>Public Key:</strong> ${identity.publicKey}</p>
                    
                    <h3>Ephemeral Key Pairs (each unique!):</h3>
                    ${ephemeralResults.map((eph, i) => `
                        <div style="margin: 10px 0; padding: 10px; background: #f0f0f0;">
                            <h4>Ephemeral Key ${i + 1}:</h4>
                            <p><strong>Private:</strong> ${eph.privateKey.slice(0, 32)}...</p>
                            <p><strong>Public:</strong> ${eph.publicKey}</p>
                        </div>
                    `).join('')}
                    
                    <p style="color: green; font-weight: bold;">
                        ✅ All keys are different - real cryptographic randomness confirmed!
                    </p>
                `;
                
                // Verify all public keys are different
                const allPubKeys = [identity.publicKey, ...ephemeralResults.map(e => e.publicKey)];
                const uniquePubKeys = new Set(allPubKeys);
                
                if (uniquePubKeys.size !== allPubKeys.length) {
                    results.innerHTML += '<p style="color: red;">⚠️ Warning: Duplicate keys detected!</p>';
                }
                
            } catch (error) {
                results.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                console.error(error);
            }
        });
    </script>
</body>
</html>